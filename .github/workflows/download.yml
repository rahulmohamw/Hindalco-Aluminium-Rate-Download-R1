name: Daily Hindalco PDF Download

on:
  schedule:
    # Runs at 4 PM UTC daily (adjust timezone as needed)
    - cron: '0 16 * * *'
  
  # Allow manual triggering
  workflow_dispatch:

jobs:
  download:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run downloader
      run: python run.py
    
    - name: Upload logs as artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: download-logs
        path: logs/
        retention-days: 30
    
    - name: List downloaded files
      run: |
        echo "📁 Checking downloads directory:"
        ls -la downloads/ || echo "❌ Downloads directory not found"
        echo ""
        echo "📁 Full directory structure:"
        find downloads -type f 2>/dev/null || echo "❌ No files found in downloads"
        echo ""
        echo "📊 File details:"
        find downloads -name "*.pdf" -exec ls -lh {} \; 2>/dev/null || echo "❌ No PDF files found"
    
    - name: Upload downloaded files as artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: hindalco-pdfs-${{ github.run_number }}
        path: |
          downloads/
          logs/
        retention-days: 90
    
    - name: Show download summary
      if: success()
      run: |
        echo "📄 Download Summary:"
        echo "==================="
        if [ -d "downloads" ]; then
          find downloads -name "*.pdf" -type f | while read file; do
            size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo "unknown")
            echo "✅ Downloaded: $file (${size} bytes)"
          done
        else
          echo "❌ No files downloaded today"
        fi
        echo "==================="
        echo "💡 Files are available as workflow artifacts for download"
